<% 
  const safeCurrentCategory = (typeof currentCategory !== 'undefined') ? currentCategory : "";
  const safeSelectedSort = (typeof selectedSort !== 'undefined') ? selectedSort : "";
  const safeAllCountries = (typeof allCountries !== 'undefined') ? allCountries : [];
  const safeSelectedCountries = (typeof selectedCountries !== 'undefined') ? selectedCountries : [];
  
%>
<form action="/listings" method="GET">
  
  <% if (safeCurrentCategory) { %>
    <input type="hidden" name="category" value="<%= safeCurrentCategory %>">
  <% } %>

  <div class="accordion" id="filterAccordion">

    <div class="accordion-item">
      <h2 class="accordion-header" id="headingSort">
        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSort" aria-expanded="true" aria-controls="collapseSort">
          <strong>Sort By</strong>
        </button>
      </h2>
      <div id="collapseSort" class="accordion-collapse collapse show" aria-labelledby="headingSort" data-bs-parent="#filterAccordion">
        <div class="accordion-body">
          <label for="sort" class="form-label">Sort options:</label>
          <select id="sort" name="sort" class="form-select">
            <option value="" <%= safeSelectedSort === '' ? 'selected' : '' %>>Default</option>
            <option value="price_asc" <%= safeSelectedSort === 'price_asc' ? 'selected' : '' %>>
              Price: Low to High
            </option>
            <option value="price_desc" <%= safeSelectedSort === 'price_desc' ? 'selected' : '' %>>
              Price: High to Low
            </option>
           
          </select>
        </div>
      </div>
    </div>

    <div class="accordion-item">
      <h2 class="accordion-header" id="headingCountry">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCountry" aria-expanded="false" aria-controls="collapseCountry">
          <strong>Filter by Country</strong>
        </button>
      </h2>
      <div id="collapseCountry" class="accordion-collapse collapse" aria-labelledby="headingCountry" data-bs-parent="#filterAccordion">
        <div class="accordion-body">
          <div class="form-control" style="max-height: 250px; overflow-y: auto;">
            <% safeAllCountries.forEach(country => { %>
              <% const isChecked = safeSelectedCountries.includes(country); %>
              <div class="form-check">
                <input 
                  class="form-check-input"
                  type="checkbox" 
                  id="country-<%= country %>" 
                  name="country" 
                  value="<%= country %>"
                  <%= isChecked ? 'checked' : '' %>
                >
                <label class="form-check-label" for="country-<%= country %>">
                  <%= country %>
                </label>
              </div>
            <% }); %>
          </div>
        </div>
      </div>
    </div>

  </div> <div class="mt-3">
    <button type="submit" class="btn btn-primary w-100 mb-2">Apply Filters</button>
    <a href="/listings?category=<%= safeCurrentCategory %>" class="btn btn-outline-secondary w-100">Clear Filters</a>
  </div>

</form>